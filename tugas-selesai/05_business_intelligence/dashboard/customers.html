<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SATRIAMART BI Dashboard - Customer Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-green-700 to-green-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="text-2xl font-bold">üìä SATRIAMART</div>
                    <div class="text-sm opacity-90">Business Intelligence Dashboard</div>
                </div>
                <div class="flex space-x-1">
                    <a href="index.html" class="px-4 py-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition">Dashboard</a>
                    <a href="sales.html" class="px-4 py-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition">Sales</a>
                    <a href="products.html" class="px-4 py-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition">Products</a>
                    <a href="customers.html" class="px-4 py-2 bg-white bg-opacity-20 rounded-lg font-medium">Customers</a>
                    <a href="financial.html" class="px-4 py-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition">Financial</a>
                    <a href="operations.html" class="px-4 py-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition">Operations</a>
                    <a href="marketing.html" class="px-4 py-2 hover:bg-white hover:bg-opacity-10 rounded-lg transition">Marketing</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-6 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Customer Analytics</h1>
                    <p class="text-gray-600 mt-1">Customer segmentation, behavior analysis, and geographic insights</p>
                </div>
                <div class="flex space-x-3">
                    <select id="filterPeriod" class="border border-gray-300 rounded-lg px-4 py-2 text-sm">
                        <option value="all">All Time</option>
                        <option value="12">Last 12 Months</option>
                        <option value="6">Last 6 Months</option>
                        <option value="3">Last 3 Months</option>
                        <option value="1">Last Month</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        
        <!-- Customer Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="text-sm text-gray-600 font-medium">Total Customers</div>
                <div class="text-3xl font-bold text-gray-800 mt-2" id="totalCustomers">0</div>
                <div class="text-xs text-gray-500 mt-1" id="newCustomers">0 new this month</div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="text-sm text-gray-600 font-medium">Avg Customer Value</div>
                <div class="text-2xl font-bold text-gray-800 mt-2" id="avgCustomerValue">Loading...</div>
                <div class="text-xs text-gray-500 mt-1">Lifetime value</div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                <div class="text-sm text-gray-600 font-medium">Repeat Customer Rate</div>
                <div class="text-3xl font-bold text-gray-800 mt-2" id="repeatRate">0%</div>
                <div class="text-xs text-gray-500 mt-1">Purchased 2+ times</div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
                <div class="text-sm text-gray-600 font-medium">Avg Rating</div>
                <div class="text-3xl font-bold text-gray-800 mt-2" id="avgRating">0.0</div>
                <div class="text-xs text-gray-500 mt-1">Customer satisfaction</div>
            </div>
        </div>

        <!-- Customer Segmentation -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Customer Segmentation (RFM)</h2>
                <div class="h-80">
                    <canvas id="segmentationChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Segment Details</h2>
                <div id="segmentDetails" class="space-y-3 h-80 overflow-y-auto">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Geographic Distribution -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Top Locations by Revenue</h2>
                <div class="h-80">
                    <canvas id="locationChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Geographic Breakdown</h2>
                <div id="locationMetrics" class="space-y-3 h-80 overflow-y-auto">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Customer Behavior Analysis -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Purchase Frequency</h2>
                <div class="h-64">
                    <canvas id="frequencyChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Gender Distribution</h2>
                <div class="h-64">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Age Group Distribution</h2>
                <div class="h-64">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Customers -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">üèÜ Top 20 Customers by Revenue</h2>
                <div class="flex space-x-3">
                    <select id="sortBy" class="text-sm border border-gray-300 rounded-lg px-3 py-1">
                        <option value="revenue">By Revenue</option>
                        <option value="transactions">By Transactions</option>
                        <option value="items">By Items Purchased</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="topCustomers">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Customer Database -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Customer Database</h2>
                <div class="flex space-x-3">
                    <select id="cityFilter" class="text-sm border border-gray-300 rounded-lg px-3 py-1">
                        <option value="">All Cities</option>
                    </select>
                    <input type="text" id="searchCustomer" placeholder="Search customers..." 
                        class="text-sm border border-gray-300 rounded-lg px-3 py-1">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Transactions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Spent</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Segment</th>
                        </tr>
                    </thead>
                    <tbody id="customerTable" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-4 py-4 text-center text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p class="text-sm">¬© 2025 SATRIAMART Business Intelligence Dashboard</p>
        </div>
    </footer>

    <script>
        let customerData = [];
        let salesData = [];
        let allSalesData = [];
        let customerStats = {};
        let charts = {};

        function formatCurrency(value) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('id-ID').format(value);
        }

        async function loadData() {
            try {
                const customerResponse = await fetch('../data/02_master_pelanggan.csv');
                const customerText = await customerResponse.text();
                const customerParsed = Papa.parse(customerText, { header: true, skipEmptyLines: true });
                customerData = customerParsed.data;

                const salesResponse = await fetch('../data/03_transaksi_penjualan.csv');
                const salesText = await salesResponse.text();
                const salesParsed = Papa.parse(salesText, { header: true, skipEmptyLines: true });
                salesData = salesParsed.data;
                allSalesData = salesParsed.data;

                calculateCustomerStats();
                calculateMetrics();
                renderCharts();
                renderTopCustomers();
                renderCustomerTable();
                populateFilters();
                
                document.getElementById('filterPeriod').addEventListener('change', applyPeriodFilter);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function calculateCustomerStats() {
            customerStats = {};
            
            salesData.forEach(row => {
                const customerId = row.id_pelanggan;
                if (!customerStats[customerId]) {
                    customerStats[customerId] = {
                        transactions: 0,
                        revenue: 0,
                        items: 0,
                        ratings: []
                    };
                }
                customerStats[customerId].transactions++;
                customerStats[customerId].revenue += parseFloat(row.total_pembayaran || 0);
                customerStats[customerId].items += parseInt(row.jumlah_item || 0);
                
                const rating = parseFloat(row.rating_pelanggan);
                if (rating > 0) {
                    customerStats[customerId].ratings.push(rating);
                }
            });
        }

        function calculateMetrics() {
            // Count only customers who have transactions in the filtered period
            const activeCustomers = Object.keys(customerStats).length;
            const totalCustomers = activeCustomers > 0 ? activeCustomers : customerData.length;
            
            const totalRevenue = Object.values(customerStats).reduce((sum, stat) => sum + stat.revenue, 0);
            const avgCustomerValue = activeCustomers > 0 ? totalRevenue / activeCustomers : 0;

            const repeatCustomers = Object.values(customerStats).filter(stat => stat.transactions >= 2).length;
            const repeatRate = activeCustomers > 0 ? (repeatCustomers / activeCustomers) * 100 : 0;

            const allRatings = Object.values(customerStats)
                .flatMap(stat => stat.ratings)
                .filter(r => r > 0);
            const avgRating = allRatings.length > 0 
                ? allRatings.reduce((a, b) => a + b, 0) / allRatings.length 
                : 0;

            document.getElementById('totalCustomers').textContent = activeCustomers;
            document.getElementById('avgCustomerValue').textContent = formatCurrency(avgCustomerValue);
            document.getElementById('repeatRate').textContent = repeatRate.toFixed(1) + '%';
            document.getElementById('avgRating').textContent = avgRating.toFixed(1);
        }

        function getCustomerSegment(transactions, revenue) {
            if (transactions >= 4) return 'VIP';
            if (transactions >= 2 && revenue >= 500000) return 'Loyal';
            if (transactions >= 2) return 'Regular';
            if (revenue >= 300000) return 'High Value';
            return 'New';
        }

        function renderCharts() {
            renderSegmentation();
            renderLocation();
            renderFrequency();
            renderGender();
            renderAge();
        }

        function renderSegmentation() {
            const segments = {
                'VIP': 0,
                'Loyal': 0,
                'Regular': 0,
                'High Value': 0,
                'New': 0
            };

            Object.entries(customerStats).forEach(([customerId, stats]) => {
                const segment = getCustomerSegment(stats.transactions, stats.revenue);
                segments[segment]++;
            });

            const ctx = document.getElementById('segmentationChart');
            if (charts.segmentation) charts.segmentation.destroy();
            charts.segmentation = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(segments),
                    datasets: [{
                        data: Object.values(segments),
                        backgroundColor: [
                            'rgb(251, 191, 36)',
                            'rgb(34, 197, 94)',
                            'rgb(59, 130, 246)',
                            'rgb(168, 85, 247)',
                            'rgb(156, 163, 175)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Render segment details
            const segmentRevenue = {};
            Object.entries(customerStats).forEach(([customerId, stats]) => {
                const segment = getCustomerSegment(stats.transactions, stats.revenue);
                if (!segmentRevenue[segment]) {
                    segmentRevenue[segment] = { count: 0, revenue: 0, transactions: 0 };
                }
                segmentRevenue[segment].count++;
                segmentRevenue[segment].revenue += stats.revenue;
                segmentRevenue[segment].transactions += stats.transactions;
            });

            const detailsHtml = Object.entries(segmentRevenue)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .map(([segment, data]) => {
                    const avgRevenue = data.revenue / data.count;
                    const avgTransactions = data.transactions / data.count;
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-3">
                                <div class="font-semibold text-gray-800">${segment}</div>
                                <div class="text-sm text-green-600 font-bold">${formatCurrency(data.revenue)}</div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div>
                                    <div class="text-gray-500">Customers</div>
                                    <div class="font-semibold text-gray-700">${data.count}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">Avg Revenue</div>
                                    <div class="font-semibold text-gray-700">${formatCurrency(avgRevenue)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">Avg Transactions</div>
                                    <div class="font-semibold text-gray-700">${avgTransactions.toFixed(1)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            document.getElementById('segmentDetails').innerHTML = detailsHtml;
        }

        function renderLocation() {
            const locationData = {};
            
            customerData.forEach(customer => {
                const city = customer.kota || 'Unknown';
                const stats = customerStats[customer.id_pelanggan] || { revenue: 0 };
                
                if (!locationData[city]) {
                    locationData[city] = { customers: 0, revenue: 0, transactions: 0 };
                }
                locationData[city].customers++;
                locationData[city].revenue += stats.revenue;
                locationData[city].transactions += stats.transactions || 0;
            });

            const sorted = Object.entries(locationData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10);

            const ctx = document.getElementById('locationChart');
            if (charts.location) charts.location.destroy();
            charts.location = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(item => item[0]),
                    datasets: [{
                        label: 'Revenue',
                        data: sorted.map(item => item[1].revenue),
                        backgroundColor: 'rgb(34, 197, 94)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });

            // Location metrics
            const metricsHtml = sorted.map(([city, data]) => {
                const avgPerCustomer = data.revenue / data.customers;
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-3">
                            <div class="font-semibold text-gray-800">${city}</div>
                            <div class="text-sm text-green-600 font-bold">${formatCurrency(data.revenue)}</div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div>
                                <div class="text-gray-500">Customers</div>
                                <div class="font-semibold text-gray-700">${data.customers}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">Transactions</div>
                                <div class="font-semibold text-gray-700">${data.transactions}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">Avg/Customer</div>
                                <div class="font-semibold text-gray-700">${formatCurrency(avgPerCustomer)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('locationMetrics').innerHTML = metricsHtml;
        }

        function renderFrequency() {
            const frequency = {
                '1 purchase': 0,
                '2-3 purchases': 0,
                '4-5 purchases': 0,
                '6+ purchases': 0
            };

            Object.values(customerStats).forEach(stats => {
                if (stats.transactions === 1) frequency['1 purchase']++;
                else if (stats.transactions <= 3) frequency['2-3 purchases']++;
                else if (stats.transactions <= 5) frequency['4-5 purchases']++;
                else frequency['6+ purchases']++;
            });

            const ctx = document.getElementById('frequencyChart');
            if (charts.frequency) charts.frequency.destroy();
            charts.frequency = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(frequency),
                    datasets: [{
                        data: Object.values(frequency),
                        backgroundColor: [
                            'rgb(156, 163, 175)',
                            'rgb(59, 130, 246)',
                            'rgb(34, 197, 94)',
                            'rgb(251, 191, 36)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderGender() {
            const genderData = {};
            
            customerData.forEach(customer => {
                const gender = customer.jenis_kelamin || 'Unknown';
                genderData[gender] = (genderData[gender] || 0) + 1;
            });

            const ctx = document.getElementById('genderChart');
            if (charts.gender) charts.gender.destroy();
            charts.gender = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(genderData),
                    datasets: [{
                        data: Object.values(genderData),
                        backgroundColor: [
                            'rgb(59, 130, 246)',
                            'rgb(236, 72, 153)',
                            'rgb(156, 163, 175)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderAge() {
            const ageGroups = {
                '18-25': 0,
                '26-35': 0,
                '36-45': 0,
                '46-55': 0,
                '56+': 0
            };

            customerData.forEach(customer => {
                const age = parseInt(customer.usia || 0);
                if (age >= 18 && age <= 25) ageGroups['18-25']++;
                else if (age <= 35) ageGroups['26-35']++;
                else if (age <= 45) ageGroups['36-45']++;
                else if (age <= 55) ageGroups['46-55']++;
                else if (age > 55) ageGroups['56+']++;
            });

            const ctx = document.getElementById('ageChart');
            if (charts.age) charts.age.destroy();
            charts.age = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageGroups),
                    datasets: [{
                        label: 'Customers',
                        data: Object.values(ageGroups),
                        backgroundColor: 'rgb(168, 85, 247)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderTopCustomers() {
            // Only show customers who have transactions in the filtered period
            const activeCustomerIds = Object.keys(customerStats);
            const activeCustomers = customerData.filter(customer => 
                activeCustomerIds.includes(customer.id_pelanggan)
            );
            
            const customersWithStats = activeCustomers.map(customer => ({
                ...customer,
                stats: customerStats[customer.id_pelanggan] || { transactions: 0, revenue: 0, items: 0, ratings: [] }
            }));

            const sorted = customersWithStats
                .sort((a, b) => b.stats.revenue - a.stats.revenue)
                .slice(0, 20);

            const html = sorted.map((customer, index) => {
                const segment = getCustomerSegment(customer.stats.transactions, customer.stats.revenue);
                const segmentColor = {
                    'VIP': 'bg-yellow-100 text-yellow-800',
                    'Loyal': 'bg-green-100 text-green-800',
                    'Regular': 'bg-blue-100 text-blue-800',
                    'High Value': 'bg-purple-100 text-purple-800',
                    'New': 'bg-gray-100 text-gray-800'
                }[segment];

                const avgRating = customer.stats.ratings.length > 0
                    ? customer.stats.ratings.reduce((a, b) => a + b, 0) / customer.stats.ratings.length
                    : 0;

                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center justify-center w-8 h-8 bg-green-100 text-green-700 rounded-full font-bold text-sm">
                                    ${index + 1}
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">${customer.nama_lengkap}</div>
                                    <div class="text-xs text-gray-500">${customer.kota}</div>
                                </div>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${segmentColor}">
                                ${segment}
                            </span>
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-xs">
                            <div>
                                <div class="text-gray-500">Revenue</div>
                                <div class="font-semibold text-green-600">${formatCurrency(customer.stats.revenue)}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">Purchases</div>
                                <div class="font-semibold text-gray-700">${customer.stats.transactions}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">Items</div>
                                <div class="font-semibold text-gray-700">${customer.stats.items}</div>
                            </div>
                            <div>
                                <div class="text-gray-500">Rating</div>
                                <div class="font-semibold text-gray-700">${avgRating > 0 ? avgRating.toFixed(1) + ' ‚≠ê' : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('topCustomers').innerHTML = html;

            // Sort by selector
            document.getElementById('sortBy').addEventListener('change', function() {
                const sortBy = this.value;
                let sorted;
                
                if (sortBy === 'revenue') {
                    sorted = customersWithStats.sort((a, b) => b.stats.revenue - a.stats.revenue);
                } else if (sortBy === 'transactions') {
                    sorted = customersWithStats.sort((a, b) => b.stats.transactions - a.stats.transactions);
                } else if (sortBy === 'items') {
                    sorted = customersWithStats.sort((a, b) => b.stats.items - a.stats.items);
                }
                
                const html = sorted.slice(0, 20).map((customer, index) => {
                    const segment = getCustomerSegment(customer.stats.transactions, customer.stats.revenue);
                    const segmentColor = {
                        'VIP': 'bg-yellow-100 text-yellow-800',
                        'Loyal': 'bg-green-100 text-green-800',
                        'Regular': 'bg-blue-100 text-blue-800',
                        'High Value': 'bg-purple-100 text-purple-800',
                        'New': 'bg-gray-100 text-gray-800'
                    }[segment];

                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="flex items-center justify-center w-8 h-8 bg-green-100 text-green-700 rounded-full font-bold text-sm">
                                        ${index + 1}
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-800">${customer.nama_lengkap}</div>
                                        <div class="text-xs text-gray-500">${customer.kota}</div>
                                    </div>
                                </div>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${segmentColor}">
                                    ${segment}
                                </span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-xs">
                                <div>
                                    <div class="text-gray-500">Revenue</div>
                                    <div class="font-semibold text-green-600">${formatCurrency(customer.stats.revenue)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">Purchases</div>
                                    <div class="font-semibold text-gray-700">${customer.stats.transactions}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">Items</div>
                                    <div class="font-semibold text-gray-700">${customer.stats.items}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">Rating</div>
                                    <div class="font-semibold text-gray-700">${customer.stats.ratings.length > 0 ? (customer.stats.ratings.reduce((a, b) => a + b, 0) / customer.stats.ratings.length).toFixed(1) + ' ‚≠ê' : 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('topCustomers').innerHTML = html;
            });
        }

        function renderCustomerTable() {
            const tbody = document.getElementById('customerTable');
            
            // Only show customers who have transactions in the filtered period
            const activeCustomerIds = Object.keys(customerStats);
            const activeCustomers = customerData.filter(customer => 
                activeCustomerIds.includes(customer.id_pelanggan)
            );
            
            const customersWithStats = activeCustomers.map(customer => ({
                ...customer,
                stats: customerStats[customer.id_pelanggan] || { transactions: 0, revenue: 0, items: 0 }
            }));

            const html = customersWithStats.map(customer => {
                const segment = getCustomerSegment(customer.stats.transactions, customer.stats.revenue);
                const segmentColor = {
                    'VIP': 'bg-yellow-100 text-yellow-800',
                    'Loyal': 'bg-green-100 text-green-800',
                    'Regular': 'bg-blue-100 text-blue-800',
                    'High Value': 'bg-purple-100 text-purple-800',
                    'New': 'bg-gray-100 text-gray-800'
                }[segment];

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900">${customer.nama_lengkap}</div>
                            <div class="text-xs text-gray-500">${customer.id_pelanggan}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            <div>${customer.email}</div>
                            <div class="text-xs">${customer.nomor_telepon}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${customer.kota}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-semibold">${customer.stats.transactions}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${customer.stats.items}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-green-600">${formatCurrency(customer.stats.revenue)}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${segmentColor}">
                                ${segment}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html;
        }

        function applyPeriodFilter() {
            const period = document.getElementById('filterPeriod').value;
            
            if (period === 'all') {
                salesData = allSalesData;
            } else {
                const months = parseInt(period);
                const cutoffDate = new Date();
                cutoffDate.setMonth(cutoffDate.getMonth() - months);
                
                salesData = allSalesData.filter(row => {
                    const date = new Date(row.tanggal_transaksi);
                    return date >= cutoffDate;
                });
            }
            
            // Refresh all displays
            calculateCustomerStats();
            calculateMetrics();
            
            // Destroy old charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            renderCharts();
            renderTopCustomers();
            renderCustomerTable();
        }

        function populateFilters() {
            const cities = [...new Set(customerData.map(c => c.kota))].sort();
            const cityFilter = document.getElementById('cityFilter');
            
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                cityFilter.appendChild(option);
            });

            cityFilter.addEventListener('change', filterCustomers);
            document.getElementById('searchCustomer').addEventListener('input', filterCustomers);
        }

        function filterCustomers() {
            const city = document.getElementById('cityFilter').value;
            const search = document.getElementById('searchCustomer').value.toLowerCase();

            const filtered = customerData.filter(customer => {
                const matchCity = !city || customer.kota === city;
                const matchSearch = !search || 
                    customer.nama_lengkap.toLowerCase().includes(search) ||
                    customer.email.toLowerCase().includes(search) ||
                    customer.id_pelanggan.toLowerCase().includes(search);
                return matchCity && matchSearch;
            });

            const tbody = document.getElementById('customerTable');
            const customersWithStats = filtered.map(customer => ({
                ...customer,
                stats: customerStats[customer.id_pelanggan] || { transactions: 0, revenue: 0, items: 0 }
            }));

            const html = customersWithStats.map(customer => {
                const segment = getCustomerSegment(customer.stats.transactions, customer.stats.revenue);
                const segmentColor = {
                    'VIP': 'bg-yellow-100 text-yellow-800',
                    'Loyal': 'bg-green-100 text-green-800',
                    'Regular': 'bg-blue-100 text-blue-800',
                    'High Value': 'bg-purple-100 text-purple-800',
                    'New': 'bg-gray-100 text-gray-800'
                }[segment];

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900">${customer.nama_lengkap}</div>
                            <div class="text-xs text-gray-500">${customer.id_pelanggan}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            <div>${customer.email}</div>
                            <div class="text-xs">${customer.nomor_telepon}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${customer.kota}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-semibold">${customer.stats.transactions}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${customer.stats.items}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-green-600">${formatCurrency(customer.stats.revenue)}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${segmentColor}">
                                ${segment}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html || '<tr><td colspan="7" class="px-4 py-4 text-center text-gray-500">No customers found</td></tr>';
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
